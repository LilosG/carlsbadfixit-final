---
import { getCollection, type CollectionEntry } from "astro:content";
import type { PaginateFunction } from "astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import PageCtaStrip from "../../components/PageCtaStrip.astro";
import BlogIndexContent from "../../components/BlogIndexContent.astro";
import { getCollectionPageJsonLd } from "../../lib/seo";
import { serviceAreas } from "../../data/service-areas";

type BlogPost = CollectionEntry<"blog">;
type PaginatedPage<T> = {
  data: T[];
  currentPage: number;
  lastPage: number;
  url: {
    prev?: string;
    next?: string;
  };
};

export async function getStaticPaths({
  paginate,
}: {
  paginate: PaginateFunction;
}) {
  const posts = (await getCollection("blog")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
  );
  const remaining = posts.filter((post) => !post.data.featured);

  return paginate(remaining, { pageSize: 9 }).filter(
    (page) => page.params.page !== "1",
  );
}

const { page } = Astro.props as { page: PaginatedPage<BlogPost> };
const areaLabels = new Map(serviceAreas.map((area) => [area.slug, area.label]));

const collectionJsonLd = JSON.stringify(
  getCollectionPageJsonLd({
    url: `/blog/${page.currentPage}/`,
    name: `Home maintenance tips for North County San Diego (Page ${page.currentPage})`,
    description:
      "Local handyman insights for Carlsbad, Oceanside, and Encinitas homeowners. Practical repair tips and project planning guidance that make it easier to schedule the right visit.",
    items: page.data.map((post: BlogPost) => ({
      name: post.data.title,
      url: `/blog/${post.slug}/`,
    })),
  }),
);
---

<BaseLayout
  title={`Home Maintenance Tips for North County San Diego | Page ${page.currentPage}`}
  description="Local handyman insights for North County San Diego homeowners. Practical tips, checklists, and planning guidance for small repair projects."
>
  <script
    type="application/ld+json"
    slot="head"
    is:inline
    set:html={collectionJsonLd}
  />

  <section class="shadow-card rounded-3xl bg-white p-6 md:p-8">
    <div
      class="grid gap-8 md:grid-cols-[minmax(0,1.6fr)_minmax(0,1fr)] md:items-center"
    >
      <div class="space-y-4">
        <p class="eyebrow text-cf-textMuted">Blog</p>
        <h1 class="text-h1 text-cf-text font-semibold">
          Home maintenance tips for North County San Diego
        </h1>
        <p class="text-body-sm text-cf-textMuted">
          Practical, contractor-informed guidance for homeowners in Carlsbad,
          Oceanside, and Encinitas. Use these checklists and insights to plan
          small repair projects, prioritize punch lists, and schedule visits
          with clear expectations.
        </p>
        <div class="flex flex-wrap gap-3 text-xs">
          <span class="badge">Carlsbad, CA</span>
          <span class="badge">Oceanside, CA</span>
          <span class="badge">Encinitas, CA</span>
        </div>
      </div>
      <aside
        class="bg-cf-sandSoft text-cf-text shadow-soft rounded-3xl p-5 text-sm"
      >
        <p
          class="text-cf-textMuted text-xs font-semibold tracking-wide uppercase"
        >
          Looking for help now?
        </p>
        <h2 class="text-cf-text mt-2 text-lg font-semibold">
          Request a handyman visit with a clear plan
        </h2>
        <p class="text-cf-textMuted mt-2 text-sm">
          Share a short list of tasks, your location, and timing preferences.
          You will receive clear next steps before scheduling.
        </p>
        <div class="mt-4 flex flex-wrap gap-2 text-xs">
          <a href="/contact/" class="btn-primary text-xs">
            Request an estimate
          </a>
          <a href="/services/" class="btn-outline text-xs"> Browse services </a>
        </div>
      </aside>
    </div>
  </section>

  <BlogIndexContent
    featuredPosts={[]}
    remainingPosts={page.data}
    areaLabels={areaLabels}
    pagination={{
      currentPage: page.currentPage,
      totalPages: page.lastPage,
      prevUrl: page.url.prev ?? undefined,
      nextUrl: page.url.next ?? undefined,
    }}
  />

  <PageCtaStrip
    eyebrow="Need a local handyman?"
    title="Schedule a focused visit for your home"
    body="Use the blog as a planning tool, then share your punch list and location for a clear, no-obligation estimate."
    primaryHref="/contact/"
    primaryLabel="Request an estimate"
    secondaryHref="/service-areas/"
    secondaryLabel="View service areas"
  />
</BaseLayout>
